/* -------------------------------------------------------------
	@ 名称：移动H5学用方法集合
	@ 功能：横竖屏判断、背景音乐、判断设备、微信分享
	@ 版本：v1.0
	@ 作者：繁花落尽|cici
	@ 时间：2015/10/15
	@ 修改：2016/03/01 --by cici
	
	@ 分享配置地址
	'http://phptest.guoxinad.com.cn/weixinshare/index.php',    //常用、小康、咪咕 【guoxinad.com.cn/insun-china.com/makainfo.com】
	'https://yidian.weiyihui.com.cn/weixinshare/index.php',     //一点资讯 【guoxinad.com.cn/insun-china.com/weiyihui.com.cn】
	'http://www.hjgmk.com/weixinshare/index.php'              //黑金根 【hjgmk.com】
*/
!(function($){
	var Cici = function(opts) {
		this.version = 'v1.0';
		this.hei = $(window).height();
		this.url = location.href.split('#')[0];
		this.evt = 'ontouchstart' in window ? 'touchstart' : 'click';
		this.bgAud = null;

		//基础配置
		var setting = {
			host: '',
			loadMsg: { datas:[], loadNum: $('.loadNum'), progress: { flag: false, loadProDiv: $('.loadProDiv'), loadPro: $('.loadPro'), initWid: 0, allWid: 0 }, callback: function(){}},
			orientMsg: {oriIco: 'images/orient.png', oriWrd: '为了更好的体验，请使用竖屏浏览'},   //参数1：提示图片   参数2：提示文案
			deviceMsg: '手机扫码浏览网页效果更佳',                                               //判断设备及提示
			musicMsg: {src: 'music/bg.mp3', playIco: 'images/play.png', pauseIco: 'images/pause.png', autoPlay: false},   //参数1：音乐路径    参数2：播放图标   参数3：暂停图标
			wxAjax: {num: 0, url: ['http://phptest.guoxinad.com.cn/weixinshare/index.php', 'https://yidian.weiyihui.com.cn/weixinshare/index.php', 'http://www.hjgmk.com/weixinshare/index.php']}
		}	
		//整合
		var opt = $.extend(true, {}, setting, opts);
		
		this.host = opt.host;
		this.orientMsg = opt.orientMsg;
		this.deviceMsg = opt.deviceMsg;
		this.musicMsg = opt.musicMsg;
		this.wxAjax = opt.wxAjax;
		this.loadMsg = opt.loadMsg;
		this.init();

		var ths = this;
	    if (this.hei >= 960) {
	        //大屏
	        $('.tk,.bg,.page,.wrap').css('height', this.hei);
	        $('.tk,.bg,.page,.wrap').css('width', this.wid);
	        $('.wrap').removeClass('clearStopSlide');
	        $('.wrap').css('overflow', 'hidden');
			document.addEventListener('touchmove', ths.stopSlide, false);

	    } else {
	        //小屏
	        $('.page,.tk,.bg,.wrap,.range_lst').addClass('clearStopSlide');
	        // $('.page').css('overflow', 'hidden')
	        //$('.tk,.bg,.page,.wrap').css('height', 1027);
	        document.removeEventListener('touchmove', ths.stopSlide, false);
	        $('.clearStopSlide').on('touchmove', function () { //释放默认事件
	            document.removeEventListener('touchmove', ths.stopSlide, false);
	        }).on('touchend', function () {
	            document.removeEventListener('touchmove', ths.stopSlide, false);
	        });
	    }
	}

	Cici.prototype = {
		init: function() { 
			this.preloadImg(this.loadMsg);
			this.orient(this);         //横竖屏
			this.device(this);         //判断设备
			this.stopEvent(this);
			this.smallScreen();    //小屏兼容
			this.initWxConfig(this);  //微信配置 

			if(this.musicMsg.autoPlay){
				this.bgMusic(this);   //背景音乐
			}
		},
		smallScreen: function(){
			if (this.hei < 960) {
				$('head').append('<link rel="stylesheet" href="css/small.css" />');
			}
		},
		stopEvent: function(ths){
			//添加事件
			document.addEventListener('touchmove', ths.stopSlide, false);
			
			$('.clearStopSlide').on('touchmove', function() { //释放默认事件
				document.removeEventListener('touchmove', ths.stopSlide, false);
			}).on('touchend', function() {
				document.addEventListener('touchmove', ths.stopSlide, false);
			})		
		},
		orient: function(ths) { //横竖屏提示
			function init() {
				var htm = '<div id="orientLayer" class="orientLayer"><img src="' + ths.orientMsg.oriIco + '" class="orientIcon"><div class="orientWrd">' + ths.orientMsg.oriWrd + '</div></div>';
				var sty = '.orientLayer{height:100%;width:100%;background:rgba(0,0,0,.8);position:fixed;left:0;top:0;z-index:999;text-align:center}.orientIcon{width:67px;height:109px;margin-top:80px;transform:rotate(90deg);-webkit-transform:rotate(90deg);-webkit-animation:rotation infinite 1.5s ease-in-out;animation:rotation infinite 1.5s ease-in-out}.orientWrd{margin-top:20px;color:#fff;font:18px/1.5 Microsoft Yahei}@keyframes rotation{10%{transform:rotate(90deg);-webkit-transform:rotate(90deg)}50%{transform:rotate(0);-webkit-transform:rotate(0)}60%{transform:rotate(0);-webkit-transform:rotate(0)}90%{transform:rotate(90deg);-webkit-transform:rotate(90deg)}100%{transform:rotate(90deg);-webkit-transform:rotate(90deg)}}@-webkit-keyframes rotation{10%{transform:rotate(90deg);-webkit-transform:rotate(90deg)}50%{transform:rotate(0);-webkit-transform:rotate(0)}60%{transform:rotate(0);-webkit-transform:rotate(0)}90%{transform:rotate(90deg);-webkit-transform:rotate(90deg)}100%{transform:rotate(90deg);-webkit-transform:rotate(90deg)}}';
				var chks = document.documentElement.clientWidth > document.documentElement.clientHeight ? 'landscape' : 'portrait';

				if (chks == 'landscape') {
					$('body').append(htm);
					$('head').append('<style class="style-orient">' + sty + '</style>')
				} else {
					$('.orientLayer,.style-orient').hide().remove();
				}
			}
			init();
			window.addEventListener("onorientationchange" in window ? "orientationchange" : "resize", function() {
				setTimeout(init, 100);
			}, false)
		},
		device: function(ths) { //判断设备类型，PC端打开WAP页面不扫码操作
			function init(){
				var userAgentInfo = navigator.userAgent;
				var Agents = new Array("Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod");
				//var dev = '<div class="device" id="device"><img src="https://chart.googleapis.com/chart?cht=qr&chs=150x150&choe=UTF-8&chld=L|4&chl=' + document.URL + '" width="300" height="300" alt="二维码"  class="deImg"><p class="deWrd">' + ths.deviceMsg + '</p></div>';
				var dev = '<div class="device" id="device"><img src="images/ewm.jpg" width="300" height="300" alt="二维码"  class="deImg"><p class="deWrd">' + ths.deviceMsg + '</p></div>';
				var sty = '.device { width: 100%; height: 100%; background: rgba(0,0,0,.8); text-align: center; position: absolute; top: 0; left: 0; z-index: 1000; }.deImg { padding-top: 160px; }.deWrd { padding-top: 20px; font-size: 24px; color: #fff; }'
				var flag = true,
					len = Agents.length;
				for (var v = 0; v < len; v++) {
					if (userAgentInfo.indexOf(Agents[v]) > 0) {
						flag = false;
						break;
					}
				}
				$('.device,.style-device').remove();
				if (flag) {
					$('body').append(dev);
					$('head').append('<style class="style-device">' + sty + '</style>')
				}
			};
			init();
			window.addEventListener('resize', function() {
				init();
			}, false)
		},
		preloadImg: function(loadMsg) {
			//load
			var loader = new PxLoader();
			var LoadingImg = [];

			var loadNum = loadMsg.loadNum;
			var progress = loadMsg.progress;
			var callback = loadMsg.callback;

			//添加页面的图片
			$('img').each(function() {
				if (!$(this).attr('src')) return;
				LoadingImg.push($(this).attr('src'));
			});

			//背景图，动态调用图
			var imgLen = loadMsg.datas.length;
			if(imgLen>0){
				for(var i=0; i<imgLen; i++){
					LoadingImg.push(loadMsg.datas[i]);
				}
			}

			//图片个数
			var imgLength = LoadingImg.length; //获取图片的数量

			if(imgLength>0){
				for (var i = 0; i < imgLength; i++) {
					var pxImage = new PxLoaderImage(this.host + LoadingImg[i]);
					pxImage.imageNumber = i + 1;
					loader.add(pxImage);
				}

				//监听加载的过程
				loader.addProgressListener(function(e) {
					var completedCount = e.completedCount; //完成图片的数量
					var percent = parseInt(completedCount * 100 / imgLength); //加载的百分比
					var cssLeft = parseInt(percent / 100); //移动距离
					if(loadNum!=null){
						loadNum.text(percent + '%');
					}
					
					if(progress.flag){
						progress.loadProDiv.show();
						progress.loadPro.css({ 'width': (progress.initWid+progress.allWid*percent/100)+'px' })
					}else{
						progress.loadProDiv.hide();
					}

					if(progress.flag){
						progress.loadProDiv.show();
					}
					
				});

				loader.addCompletionListener(function() {
					setTimeout(function() {
						$('.loading').fadeOut(100);
						callback();
					}, 500);
				});

			}else{
				$('.loading').fadeOut(100);
			}
			loader.start();
		},
		preLoadAud: function(src, callback){
			var aud = new Audio();
				callback = callback || function(){};
			aud.addEventListener('loadstart', function(){
				//$('.tk-load').show();
			}, false)

			aud.addEventListener('loadedmetadata', function(){
				//$('.tk-load').hide();
				callback();
			}, false)

			aud.src = src;
			aud.autoplay = 'autoplay';
			aud.loop = true;//循环播放
			return aud;
		},
		bgMusic: function(ths) { //背景音乐
			var ico = $('<span class="mIco reverseRotataZ" id="mIco"></span>');
			var sty = '.mIco { position: absolute; top: 10px; right: 10px; width: 54px; height: 54px; display: block; background: url(' + ths.musicMsg.playIco + ') no-repeat center; z-index: 1000; }.zanting { background-image: url(' + ths.musicMsg.pauseIco + '); }.reverseRotataZ { -webkit-animation: reverseRotataZ 1.5s infinite; animation: reverseRotataZ 1.5s infinite; }@-webkit-keyframes reverseRotataZ {0% { -webkit-transform: rotateZ(0deg); }100% { -webkit-transform: rotateZ(-360deg); }}@-webkit-keyframes rotataZ {0% { -webkit-transform: rotateZ(0deg); }100% { -webkit-transform: rotateZ(360deg); }}';
			$('body').append(ico);
			$('head').append('<style class="style-music">' + sty + '</style>');

			ths.bgAud = this.preLoadAud(ths.musicMsg['src'], function(){
				ths.playMusic(ths.bgAud, true);

				//ios兼容处理
				document.addEventListener("WeixinJSBridgeReady", function() {
					ths.playMusic(ths.bgAud, true);
				}, false);

				//点击播放/暂停
				$('.mIco').live(ths.evt, function() {
					if (ths.bgAud.paused) {
						ths.playMusic(ths.bgAud, true);
					} else {
						ths.closeMusic(ths.bgAud, true);
					}
				})
			});
		},
		playMusic: function(ele, isBg) {
			ele.play();
			if(isBg){
				$('.mIco').removeClass('zanting').addClass('reverseRotataZ');
			}
		},
		closeMusic: function(ele, isBg) {
			ele.pause();
			if(isBg){
				$('.mIco').removeClass('reverseRotataZ').addClass('zanting');
			}
		},
		slide: function(now, next, opt) {　//单页面之间的切换动画　now　 当前页面  next 下一页     opt 进出动画，类名
			opt = opt||{};
			var outClass = opt.outClass||'moveToTop';
			var inClass = opt.inClass||'moveFromBottom';
			
			next.addClass('current');
			setTimeout(function(){
			now.addClass(outClass);
			}, 10);
				next.addClass(inClass);
			
			setTimeout(function(){
				now.removeClass('current');
				now.removeClass(outClass);
				next.removeClass(inClass);
			},600);
		},
		range: function(a, b) {　　　　　　　 //取ａ、ｂ两个之前的值　　　ａ，ｂ均为数值、不区分正负
			return parseInt(Math.random() * Math.abs(a - b) + Math.min(a,b));
		},
		randArr: function(arr) {     //随机打乱数组  注：也可用sort方法
			for (var i = arr.length; i > 0;) {
				var x = arr[--i]
				var j = parseInt(Math.random() * i);

				arr[i] = arr[j];
				arr[j] = x;
			}
			return arr;
		},
		delRepeat: function(arr) { //去重
			var narr = {};
			var len = arr.length;
			var temp = [];
			for (var i = 0; i = len; i++) {
				if (!narr[arr[i]]) {
					temp.push(arr[i]);
				}
			}
			return temp;
		},
		delArr: function(arr, val){ //删除数组中指定元素
			for(var i=0,len=arr.length; i<len; i++){
				if(arr[i]==val){
					arr.splice(i, 1);
					i--;
				}
			}
			return arr;
		},
		stopSlide: function(e) { //阻止页面默认行为
			var e = window.event || e;
			e.stopPropagation();
			e.preventDefault();
		},
		checkMobile: function(s) { //正则匹配手机号
			if (s.length != 11) return false;
			var partten = /^0?1(3|4|5|7|8|9)\d{9}$/;
			var dx = /^1[3578][01379]\d{8}$/g;
		    var lt = /^1[34578][01256]\d{8}$/g;
		    var yd = /^(134[012345678]\d{7}|1[34578][012356789]\d{8})$/g;
			return partten.test(s);
		},
		initWxConfig: function(ths){  
			$.ajax({
				url: ths.wxAjax.url[ths.wxAjax.num],
				type: "get",			// 数据发送方式          
				dataType : "jsonp",		// 接受数据格式
				jsonp: 'jsoncallback',
				data : {"url":ths.url},
				success : function(jsonData){
					if(jsonData.error == 1){
						//alert('发生错误,请联系管理员!');
					}else{
						wx.config({
							debug: false,
							//debug: true,
							appId: jsonData.appId,
							timestamp: jsonData.timestamp,
							nonceStr: jsonData.nonceStr,
							signature: jsonData.signature,
							jsApiList: [
							  'checkJsApi',
							  'onMenuShareTimeline',
							  'onMenuShareAppMessage',
							  'onMenuShareQQ',
							  'onMenuShareWeibo',
							  'closeWindow',
							  'chooseImage',
							  'uploadImage',
							  'downloadImage',
							  'previewImage'
							]
						});
						/*wx.ready(function() {
							wx.onMenuShareAppMessage(shareData);
							wx.onMenuShareTimeline(shareData);
							wx.onMenuShareQQ(shareData);
							wx.onMenuShareWeibo(shareData);
						});*/
					}
				}
			});
		},
		wxShare: function(tit, cnt, page, img) { 
			var page = this.host+page;
			var img = this.host+img;

			//分享默认带参数 &from=timeline&isappinstalled=0
			wx.ready(function() {
				//alert(lnk+','+src);

				//分享到朋友圈
				wx.onMenuShareTimeline({
					title: cnt, // 分享标题
					link: page, // 分享链接
					imgUrl: img, // 分享图标
					success: function() {
						// 用户确认分享后执行的回调函数
						//alert("为您为品加赞！");
					},
					cancel: function() {
						// 用户取消分享后执行的回调函数
						//confirm("分享不易，确定要抛弃我么T_T")
						//alert(lnk+','+src);
					}
				});

				//分享到朋友
				wx.onMenuShareAppMessage({
					title: tit, // 分享标题
					desc: cnt, // 分享描述
					link: page, // 分享链接
					imgUrl: img, // 分享图标
					type: '', // 分享类型,music、video或link，不填默认为link
					dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
					success: function() {
						// 用户确认分享后执行的回调函数
						//alert("为您为品加赞！")
					},
					cancel: function() {
						// 用户取消分享后执行的回调函数
						//confirm("分享不易，确定要抛弃我么T_T")
						//alert(lnk+','+src);
					}
				});
			})
		}
	}

	window.Cici = Cici || {};
})(Zepto);
